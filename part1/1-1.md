服务注册阶段主要分为两个过程，一是Server启动，二是服务发布。

通过Spring Schema配置或者通过@Service注解的形式配置Pigeon的Provider服务，启动服务时都会首先初始化ServiceBean并调用其init\(\)方法进行服务注册。ServiceBean中的配置属性值通过Spring Schema或@Service注解进行设置。

##### ServiceBean：

```java
public void init() throws Exception {
    ServerConfig serverConfig = new ServerConfig();
    serverConfig.setPort(port);
    serverConfig.setAutoSelectPort(autoSelectPort);
    serverConfig.setCorePoolSize(corePoolSize);
    serverConfig.setMaxPoolSize(maxPoolSize);
    serverConfig.setWorkQueueSize(workQueueSize);
    serverConfig.setEnableTest(enableTest);
    List<ProviderConfig<?>> providerConfigList = new ArrayList<ProviderConfig<?>>();
    for (String url : services.keySet()) {
        ProviderConfig<Object> providerConfig = new ProviderConfig<Object>(services.get(url));
        providerConfig.setUrl(url);
        providerConfig.setServerConfig(serverConfig);
        providerConfig.setCancelTimeout(cancelTimeout);
        providerConfigList.add(providerConfig);
    }
    
    // 进行服务注册
    ServiceFactory.addServices(providerConfigList);
}
```

通过Provider初始化配置，设置ProviderConfig并调用ServiceFactory.addServices，此过程也可以通过手工编码的方式来进行服务启动和注册。

在ServiceFactory.addServices中会遍历ProviderConfig，并逐条调用PublishPolicy.doAddService来启动Server监听和服务的注册，这个过程是整个服务注册过程的核心部分

PublishPolicy是一个SPI扩展点，Pigeon默认情况下使用DefaultPublishPolicy来进行处理，如果我们需要定制化这块处理则可以添加SPI定义来覆盖DefaultPublishPolicy的处理

##### AbstractPublishPolicy：

```java
@Override
public void doAddService(ProviderConfig providerConfig) {
    try {
        // 校验服务名定义是否合法，是否使用了预留的服务名定义
        checkServiceName(providerConfig);
        
        ServicePublisher.addService(providerConfig);
        ServerConfig serverConfig = ProviderBootStrap.startup(providerConfig);
        providerConfig.setServerConfig(serverConfig);
        ServicePublisher.publishService(providerConfig, false);
    } catch (Throwable t) {
        throw new RpcException("error while adding service:" + providerConfig, t);
    }
}
```



